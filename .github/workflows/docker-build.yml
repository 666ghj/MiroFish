---
# MiroFish Docker Build Workflow
# ä½¿ç”¨å¯å¤ç”¨çš„ Docker Build Workflow æž„å»ºå®Œæ•´åº”ç”¨
# åŸºäºŽ: Deroino/docker-build-workflow

name: Docker Build

on:
  push:
    tags:
      - 'v*.*.*'
      - 'backend-v*.*.*'
      - 'frontend-v*.*.*'
      - 'backend-*'
      - 'frontend-*'
  pull_request:
    paths-ignore:
      - 'README.md'
      - 'README-EN.md'
      - 'DOCKER.md'
      - '.github/linters/**'
      - 'docs/**'

# å–æ¶ˆåŒä¸€åˆ†æ”¯ä¸Šä¹‹å‰è¿è¡Œçš„å·¥ä½œæµ
concurrency:
  group: ${{ github.ref }}-${{ github.workflow }}
  cancel-in-progress: true

jobs:
  # ===========================================
  # æž„å»ºåŽç«¯é•œåƒ
  # ===========================================
  build-backend:

    name: Build Backend Image

    # ä½¿ç”¨æ‚¨çš„å¯å¤ç”¨å·¥ä½œæµ
    uses: Deroino/docker-build-workflow/.github/workflows/reusable-docker-build.yaml@main

    # è®¾ç½®æƒé™ï¼ˆå¿…é¡»ç­‰äºŽæˆ–å¤§äºŽå¯å¤ç”¨å·¥ä½œæµè¦æ±‚çš„æƒé™ï¼‰
    permissions:
      contents: read
      packages: write
      pull-requests: write

    # ä¼ é€’ secrets
    secrets:
      gh-token: ${{ secrets.GITHUB_TOKEN }}

    # é…ç½®è¾“å…¥å‚æ•°
    with:
      # å¯ç”¨ GitHub Container Registry
      ghcr-enable: true

      # ç¦ç”¨ Docker Hub
      dockerhub-enable: false

      # é•œåƒåç§°
      image-names: |
        ghcr.io/${{ github.repository }}

      # æž„å»ºç›®æ ‡ï¼ˆDockerfile ä¸­çš„ backend é˜¶æ®µï¼‰
      target: backend

      # å¹³å°
      platforms: linux/amd64,linux/arm64

      # æ ‡ç­¾è§„åˆ™
      tag-rules: |
        type=raw,value=backend-stable-{{date 'YYYYMMDD'}}-{{sha}},enable={{is_default_branch}},priority=300
        type=ref,event=tag,prefix=backend-,priority=200
        type=raw,value=backend-latest,enable={{is_default_branch}},priority=100
        type=raw,value=backend-gha-${{ github.run_id }},enable=${{github.event_name == 'pull_request'}},priority=200
        type=raw,value=backend-pr-{{pr}},enable=${{github.event_name == 'pull_request'}},priority=100

      # Dockerfile è·¯å¾„
      file: Dockerfile

      # æž„å»ºä¸Šä¸‹æ–‡
      context: "{{defaultContext}}"

      # å¯ç”¨ PR æ³¨é‡Š
      comment-enable: true

      # æŽ¨é€é•œåƒ
      push: ${{ github.event_name != 'pull_request' || github.event.pull_request.head.repo.full_name == github.repository }}

  # ===========================================
  # æž„å»ºå‰ç«¯é•œåƒ
  # ===========================================
  build-frontend:

    name: Build Frontend Image

    uses: Deroino/docker-build-workflow/.github/workflows/reusable-docker-build.yaml@main

    permissions:
      contents: read
      packages: write
      pull-requests: write

    secrets:
      gh-token: ${{ secrets.GITHUB_TOKEN }}

    with:
      # å¯ç”¨ GitHub Container Registry
      ghcr-enable: true

      # ç¦ç”¨ Docker Hub
      dockerhub-enable: false

      # é•œåƒåç§°
      image-names: |
        ghcr.io/${{ github.repository }}

      # æž„å»ºç›®æ ‡ï¼ˆDockerfile ä¸­çš„ frontend é˜¶æ®µï¼‰
      target: frontend

      # å¹³å°
      platforms: linux/amd64,linux/arm64

      # æ ‡ç­¾è§„åˆ™
      tag-rules: |
        type=raw,value=frontend-stable-{{date 'YYYYMMDD'}}-{{sha}},enable={{is_default_branch}},priority=300
        type=ref,event=tag,prefix=frontend-,priority=200
        type=raw,value=frontend-latest,enable={{is_default_branch}},priority=100
        type=raw,value=frontend-gha-${{ github.run_id }},enable=${{github.event_name == 'pull_request'}},priority=200
        type=raw,value=frontend-pr-{{pr}},enable=${{github.event_name == 'pull_request'}},priority=100

      # Dockerfile è·¯å¾„
      file: Dockerfile

      # æž„å»ºä¸Šä¸‹æ–‡
      context: "{{defaultContext}}"

      # å¯ç”¨ PR æ³¨é‡Š
      comment-enable: true

      # æŽ¨é€é•œåƒ
      push: ${{ github.event_name != 'pull_request' || github.event.pull_request.head.repo.full_name == github.repository }}

  # ===========================================
  # åˆ›å»ºæ‘˜è¦ï¼ˆæ˜¾ç¤ºæ‰€æœ‰é•œåƒæ ‡ç­¾ï¼‰
  # ===========================================
  summary:

    name: Build Summary

    needs: [build-backend, build-frontend]
    runs-on: ubuntu-latest

    if: always()

    permissions:
      contents: read

    steps:
      - name: Generate Summary
        run: |
          echo "# ðŸ³ MiroFish Docker Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ“¦ Built Images" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Service | Image Tag | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|-----------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Backend | \`ghcr.io/${{ github.repository }}:backend\` | ${{ needs.build-backend.result == 'success' && 'âœ… Success' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Frontend | \`ghcr.io/${{ github.repository }}:frontend\` | ${{ needs.build-frontend.result == 'success' && 'âœ… Success' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸš€ Quick Start" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo '```bash' >> $GITHUB_STEP_SUMMARY
          echo "# Pull images" >> $GITHUB_STEP_SUMMARY
          echo "docker pull ghcr.io/${{ github.repository }}:backend" >> $GITHUB_STEP_SUMMARY
          echo "docker pull ghcr.io/${{ github.repository }}:frontend" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "# Or use docker-compose" >> $GITHUB_STEP_SUMMARY
          echo "docker-compose up -d" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY